# ä»€ä¹ˆæ˜¯è¡¨æ ¼å¼(Table Format)ï¼Ÿ

**æé—®æ—¶é—´**: 2024-01-01
**å­¦ä¹ é˜¶æ®µ**: ç¬¬ä¸€é˜¶æ®µ - æ ¸å¿ƒæ¦‚å¿µæŽŒæ¡
**éš¾åº¦çº§åˆ«**: åˆçº§

## ðŸ¤” é—®é¢˜

ä»€ä¹ˆæ˜¯è¡¨æ ¼å¼(Table Format)ï¼Ÿå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

## ðŸ’¡ ç­”æ¡ˆ

### è¡¨æ ¼å¼çš„å®šä¹‰

**è¡¨æ ¼å¼(Table Format)** æ˜¯ä¸€ç§æ•°æ®ç»„ç»‡å’Œç®¡ç†çš„è§„èŒƒï¼Œå®ƒåœ¨æ–‡ä»¶å­˜å‚¨å±‚ä¹‹ä¸Šæä¾›äº†ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œä½¿å¾—å­˜å‚¨åœ¨æ•°æ®æ¹–ä¸­çš„æ–‡ä»¶å¯ä»¥åƒä¼ ç»Ÿæ•°æ®åº“è¡¨ä¸€æ ·è¿›è¡Œç®¡ç†å’ŒæŸ¥è¯¢ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦è¡¨æ ¼å¼ï¼Ÿ

åœ¨ä¼ ç»Ÿçš„æ•°æ®æ¹–æž¶æž„ä¸­ï¼Œæˆ‘ä»¬é¢ä¸´ä»¥ä¸‹é—®é¢˜ï¼š

#### 1. **æ–‡ä»¶ç®¡ç†å¤æ‚**
```
ä¼ ç»Ÿæ•°æ®æ¹–:
/data/events/year=2023/month=01/day=01/file1.parquet
/data/events/year=2023/month=01/day=01/file2.parquet
/data/events/year=2023/month=01/day=02/file3.parquet
...

é—®é¢˜ï¼š
- éœ€è¦æ‰‹åŠ¨ç®¡ç†åˆ†åŒºç›®å½•
- æ–‡ä»¶ç¢Žç‰‡åŒ–ä¸¥é‡
- å…ƒæ•°æ®åˆ†æ•£ï¼Œéš¾ä»¥ç»´æŠ¤
```

#### 2. **Schemaæ¼”è¿›å›°éš¾**
- æ·»åŠ æ–°åˆ—éœ€è¦é‡å†™æ‰€æœ‰åŽ†å²æ•°æ®
- åˆ—ç±»åž‹å˜æ›´å®¹æ˜“å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- ç¼ºä¹ç‰ˆæœ¬ç®¡ç†æœºåˆ¶

#### 3. **æ•°æ®ä¸€è‡´æ€§å·®**
- å¤šä¸ªä½œä¸šåŒæ—¶å†™å…¥å¯èƒ½å¯¼è‡´æ•°æ®æŸå
- æ²¡æœ‰äº‹åŠ¡ä¿è¯
- è¯»å†™å†²çªé¢‘ç¹

#### 4. **æŸ¥è¯¢æ€§èƒ½é—®é¢˜**
- éœ€è¦æ‰«æå¤§é‡æ–‡ä»¶æ‰èƒ½æ‰¾åˆ°ç›®æ ‡æ•°æ®
- ç¼ºä¹ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’
- åˆ†åŒºå‰ªæžæ•ˆæžœæœ‰é™

### è¡¨æ ¼å¼çš„è§£å†³æ–¹æ¡ˆ

è¡¨æ ¼å¼é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³è¿™äº›é—®é¢˜ï¼š

#### 1. **ç»Ÿä¸€å…ƒæ•°æ®ç®¡ç†**
```
è¡¨æ ¼å¼æž¶æž„:
Table Metadata
â”œâ”€â”€ Schema (åˆ—å®šä¹‰ï¼Œç±»åž‹ä¿¡æ¯)
â”œâ”€â”€ Partition Spec (åˆ†åŒºè§„åˆ™)
â”œâ”€â”€ Snapshots (æ•°æ®ç‰ˆæœ¬)
â”œâ”€â”€ Manifests (æ–‡ä»¶æ¸…å•)
â””â”€â”€ Data Files (å®žé™…æ•°æ®)
```

#### 2. **ACIDäº‹åŠ¡æ”¯æŒ**
- **åŽŸå­æ€§**: æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- **ä¸€è‡´æ€§**: æ•°æ®å§‹ç»ˆä¿æŒæœ‰æ•ˆçŠ¶æ€
- **éš”ç¦»æ€§**: å¹¶å‘æ“ä½œäº’ä¸å¹²æ‰°
- **æŒä¹…æ€§**: æäº¤çš„æ›´æ”¹æ°¸ä¹…ä¿å­˜

#### 3. **Schemaæ¼”è¿›**
- æ”¯æŒæ— ç—›æ·»åŠ ã€åˆ é™¤ã€é‡å‘½ååˆ—
- å‘å‰å‘åŽå…¼å®¹æ€§
- ç‰ˆæœ¬åŽ†å²è¿½è¸ª

#### 4. **æ—¶é—´æ—…è¡Œ**
- å¯ä»¥æŸ¥è¯¢ä»»æ„åŽ†å²æ—¶ç‚¹çš„æ•°æ®
- æ”¯æŒæ•°æ®å›žæ»š
- ä¾¿äºŽå®¡è®¡å’Œè°ƒè¯•

### ä¸»æµè¡¨æ ¼å¼å¯¹æ¯”

| ç‰¹æ€§ | Apache Iceberg | Delta Lake | Apache Hudi |
|------|----------------|------------|--------------|
| **å¼€æºåè®®** | Apache 2.0 | Apache 2.0 | Apache 2.0 |
| **ä¸»è¦åŽ‚å•†** | Netflix, Apple | Databricks | Uber |
| **å¼•æ“Žæ”¯æŒ** | Spark, Flink, Trino | Spark | Spark, Flink |
| **Schemaæ¼”è¿›** | âœ… å®Œæ•´æ”¯æŒ | âœ… å®Œæ•´æ”¯æŒ | âœ… éƒ¨åˆ†æ”¯æŒ |
| **Time Travel** | âœ… åŸºäºŽå¿«ç…§ | âœ… åŸºäºŽç‰ˆæœ¬ | âœ… åŸºäºŽæ—¶é—´ |
| **ACID** | âœ… å®Œæ•´æ”¯æŒ | âœ… å®Œæ•´æ”¯æŒ | âœ… å®Œæ•´æ”¯æŒ |
| **Hidden Partitioning** | âœ… | âŒ | âŒ |

### Iceberg vs ä¼ ç»ŸHiveè¡¨çš„åŒºåˆ«

#### **ä¼ ç»ŸHiveè¡¨çš„å±€é™**:

1. **åˆ†åŒºç®¡ç†å¤æ‚**
```sql
-- Hiveéœ€è¦æ‰‹åŠ¨åˆ›å»ºåˆ†åŒº
ALTER TABLE events ADD PARTITION (year=2023, month=01, day=01);
-- ç”¨æˆ·å¿…é¡»çŸ¥é“åˆ†åŒºç»“æž„æ‰èƒ½é«˜æ•ˆæŸ¥è¯¢
SELECT * FROM events WHERE year=2023 AND month=01;
```

2. **Schemaæ¼”è¿›å›°éš¾**
```sql
-- Hiveæ·»åŠ åˆ—é€šå¸¸éœ€è¦é‡å»ºè¡¨
ALTER TABLE events ADD COLUMNS (new_column STRING);
-- å¯èƒ½å¯¼è‡´åŽ†å²æ•°æ®ä¸¢å¤±æˆ–ä¸ä¸€è‡´
```

3. **å¹¶å‘å†™å…¥é—®é¢˜**
```
å¤šä¸ªä½œä¸šåŒæ—¶å†™å…¥åŒä¸€åˆ†åŒº â†’ æ•°æ®æŸå
è¯»å†™åŒæ—¶è¿›è¡Œ â†’ è¯»åˆ°ä¸å®Œæ•´æ•°æ®
```

#### **Icebergçš„ä¼˜åŠ¿**:

1. **Hidden Partitioning (éšè—åˆ†åŒº)**
```sql
-- åˆ›å»ºè¡¨æ—¶å®šä¹‰åˆ†åŒºè½¬æ¢
CREATE TABLE events (
    event_time timestamp,
    user_id bigint,
    event_type string
) USING ICEBERG
PARTITIONED BY (days(event_time));

-- æŸ¥è¯¢æ—¶ç”¨æˆ·æ— éœ€çŸ¥é“åˆ†åŒºç»“æž„
SELECT * FROM events
WHERE event_time >= '2023-01-01' AND event_time < '2023-01-02';
```

2. **æ— ç—›Schemaæ¼”è¿›**
```sql
-- æ·»åŠ åˆ—æ— éœ€é‡å†™åŽ†å²æ•°æ®
ALTER TABLE events ADD COLUMN user_country string;
-- è‡ªåŠ¨å¤„ç†æ–°æ—§æ•°æ®çš„å…¼å®¹æ€§
```

3. **ACIDäº‹åŠ¡ä¿è¯**
```sql
-- åŽŸå­æ€§å†™å…¥ï¼Œè¦ä¹ˆæˆåŠŸè¦ä¹ˆå¤±è´¥
INSERT INTO events SELECT * FROM staging_events;
-- è¯»å†™éš”ç¦»ï¼Œè¯»æ“ä½œçœ‹åˆ°ä¸€è‡´çš„å¿«ç…§
```

## ðŸ”— ç›¸å…³èµ„æº

- [Icebergå®˜æ–¹æ–‡æ¡£ - Table Format](https://iceberg.apache.org/docs/latest/)
- [NetflixæŠ€æœ¯åšå®¢ - Icebergè®¾è®¡åŽŸç†](https://netflixtechblog.com/iceberg-tables-turning-the-iceberg-upside-down-59bb58dd7e7c)
- [é¡¹ç›®README](../../README.md)

## ðŸ·ï¸ æ ‡ç­¾

#æ¦‚å¿µç†è§£ #è¡¨æ ¼å¼ #åŸºç¡€çŸ¥è¯† #æ•°æ®æ¹–